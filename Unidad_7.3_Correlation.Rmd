---
title: 'Unidad 7.3: Prueba de correlaci贸n'
author: "Rub茅n Mu帽oz"
date: "2024-02-16"
output: 
 html_document:
   fig_caption: yes
   toc: yes
   toc_depth: 3
   toc_float: yes
   css: custom.css

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Bienvenida
En esta Unidad 7.3 aprenderemos acerca de la prueba de correlaci贸n de Pearson. Esta es una prueba que se usa con datos continuos en la cual se calcula el grado de covariaci贸n entre variables relacionadas linealmente.
Esta prueba nos dar谩 un coeficiente de correlaci贸n, el cual nos indicar谩 qu茅 tanta correlaci贸n existe entre dos variables.
La correlaci贸n puede ser positiva o negativa y su valor m谩ximo es de 1 o -1, respectivamente.

<div style = "text-align:center"> 
![:)](../imagenes/gatoTeclado.png){width=30%} 
</div>

En este caso trtaremos de ver si existen una correlaci贸n entre el PIB y la esperanza de vida mundial.




### **Correlaci贸n**
La prueba de correlaci贸n nos arrojar谩 un coeficiente de correlaci贸n (r) y un valor de p, si el valor de $p < 0.05$ nos indica que la prueba es estad铆sticamente significativa.
En cuanto al coeficiente se suele marcar un umbral del 75% para considerar asociaci贸n entre variables.
```{r}
#Paletas de color#Rampa de colores
library(paletteer)
library(colorBlindness)
pal1 <- paletteer_d("colorBlindness::Green2Magenta16Steps")
pal2 <- paletteer_c("ggthemes::Gold-Purple Diverging", 30)
#Seleccionamos los datos
library(gapminder)
gapm <- gapminder
gapm2007 <- gapm[gapm$year == "2007", ]
# Realizamos la prueba de correlaci贸n
cor.test(gapm$gdpPercap, gapm$lifeExp)
```
La prueba es significativa con un coeficiente de r = 0.61

```{r}
# Graficamos las variables
plot(log10(gapm2007$gdpPercap), gapm2007$lifeExp,
     xlab = "PIB mundial($)",
     ylab = "Esperanza de vida promedio (a帽os)",
     pch = 21, cex = 1.5,
     bg = "#85B47B", col = "darkgreen",
     bty = "L")+ # Gr谩fico sin m谩rgenes superior y derecho)
text( x = 4.5, y = 42,  #Posici贸n 
       label = "  = 0.78",
       cex = 1.2
      )
```
No obstante,s iempre debemos verificar antes la normalidad de nuestros datos:
```{r}
shapiro.test(gapm2007$gdpPercap)
shapiro.test(gapm2007$lifeExp)
```

Nuestros datos no siguen una distribuci贸n normal, por lo que usaremos la prueba no param茅trica de Spearman:
```{r}
cor.test(gapm$gdpPercap, gapm$lifeExp,
         method = "spearman")
```
La prueba es significativa con un coeficiente de rho = 0.82.  

### **Correlograma**  

A veces es necesario evaluar la correlaci贸n entre una o m谩s variables. Para ello podemos generar una matriz de correlaci贸n y verla visualemente en R (correlograma). Para ello usamos las siguientes librer铆as:
```{r, results='hide'}
#Una vez instaladas, cargar las librerias
library(ggplot2)
library(corrplot)
library(mvnormtest)

```

En nuestro ejemplo usaremos un ejemplo de aplicaci贸n en el modelado de distribuci贸n potencial de especies.
En este ejemplo realizaremos una matriz de correlaci贸n de variables ambientales relacionadas con la distribuci贸n de la coqueta de Guerrero (*梆别梆仇 ｐ仇ゐ吼梆别娥*). Esta una especie de la familia Trochilidae (colibr铆es). La especie es end茅mica de M茅xico. Su sobrevivencia est谩 amenazada por la p茅rdida de h谩bitat. En M茅xico, la NOM-059-SEMARNAT-2010 la considera En Peligro de Extinci贸n; la UICN como En Peligro Cr铆tico.  
<div style = "text-align:center"> 
![Coqueta de Guerrero](../imagenes/coqueta.jpg){width=60%} 
</div>


Las variables ambientales se recabaron de [WorldClim](https://www.worldclim.org/) la cual es una base de datos clim谩ticos hist贸ricos a nivel mundial. Adem谩s, de la altitud registrada en un Modelo de Elevaci贸n Digital (DEM) hecho por [INEGI](https://www.inegi.org.mx/) (mexdem).
A partir de esta matriz de correlaci贸n podemos elegir las variables 贸ptimas para contruir nuestro modelo de distribuci贸n de la especie.


#### Supuestos
En el caso de que tengamos m谩s de dos variables podemos usar la librer铆a *mvnormtest* para calcular la normalidad de m煤ltiples datos. Los datos deben ser de clase *matrix*

```{r}
#Seleccionamos los datos
LBrachyVar <- read.csv("../data/LophornisBrachylophusVariables.csv",
                       header = T)

#Aplicar la prueba de normalidad de Shapiro-Wilk
#es necesario transponer (t) los datos
mshapiro.test(t(LBrachyVar))
```

Como los datos no cunmplen el supuesto de normalidad usaremos la prueba de Spearman.

```{r, fig.align='center', fig.width=11, fig.height=15}
par(mfrow = c(3,2))
#Genera el gr谩fico de correlaci贸n
mt.cor <- cor(LBrachyVar, method="spearman")

# A) Gr谩fico por default
corrplot(mt.cor,
         main = "A) Default")

# B) Gr谩fico por m茅todo = color
corrplot(mt.cor, method = 'color', #Colorea los cuadros
         order = 'alphabet',#orden alfab茅tico
         tl.cex = 0.5, tl.col = "black", #Tama帽o y color de las etiquetas
         number.cex=0.55, addCoef.col = 'black', # A帽adir coeficiente de correlaci贸n
         diag = F,
         main = "B) Method = color"
         ) 

# C) Gr谩fico por m茅todo = pie  y upper
corrplot(mt.cor, method = 'pie', #Colorea las gr谩ficas de pie
         type = "upper", # Muestra solo la regi贸n de arriba
         order = 'alphabet',#orden alfab茅tico
         tl.cex = 0.5, tl.col = "black", #Tama帽o y color de las etiquetas
         cl.cex=0.7, #Tama帽o de la simbolog铆a
         addCoef.col = 'black', # A帽adir coeficiente de correlaci贸n
         number.digits = 1,
         number.cex=0.55,
         main = "C) Pie + upper"
         ) 

# D) Otra forma del grafico: ellipse
corrplot(mt.cor, method="ellipse",
         tl.cex=0.4, tl.col = "black", 
         tl.srt = 45, 
         cl.cex=0.6,
         col = COL2('PiYG'),
         addCoef.col = 'black',
         number.cex=0.55,
         main = "D) ellipse+rampadecolores"
         )

# E) Leyenda inferior, diagonal con nombres
corrplot(mt.cor, order = "alphabet",
         method = "square",
         cl.pos = 'b', # Leyenda en bottom
         col = pal1, 
         diag = FALSE, 
         tl.cex = 0.5,
         tl.pos = "d", #Nombre de variables en la diagonal
         bg = "gray90", #Color de fondo
         main = "E) square+rampadecolores"
         )

# F) Incorporando el valor de p 
 pvalueCorr <- cor.mtest(LBrachyVar, conf.level = 0.95)
 
 corrplot(mt.cor,
         method = "color",
         type = "lower",
         p.mat = pvalueCorr$p,
         sig.level = 0.05,
         insig = "blank",
         diag = FALSE,
         addCoef.col = 'black', # A帽adir coeficiente de correlaci贸n
         number.digits = 2, # Num. digitos del coef
         number.cex = 0.7, #Tama帽o del coef
         tl.col = "black",
         tl.srt = 0, # ngulo de las variables
         cl.pos = 'b', # Leyenda en bottom
         col = COL2('PiYG'), #Nombre de variables en la diagonal
         bg = "gray95", #Color de fondo
         addgrid.col = 'gray95',#Color de l铆neas
         main = "F) valores de p"
         )
```

De esta forma podemos generar gr谩ficos con calidad para colocar en art铆culos y que nos permiten avanzar en nuestra investigaci贸n. Gracias a este correlograma podemos contruir un modelo para destinar zonas prioritarias de conservaci贸n para la coqueta de Guerrero.   
_________________  

Hemos terminado esta lecci贸n. Le agradezco su participaci贸n y espero que las herramientas vistas en este curso les sean de gran utilidad en su vida profesional y acad茅mica.

<div style = "text-align:center"> 
![Byebye:)](../imagenes/Default_create_a_cute_kitty_waving_his_paw_saying_goodbye_2.jpg){width=80%} 
</div>




